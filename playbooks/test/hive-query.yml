---

- name: Test Hive query
  hosts: "{{ groups['hive-server2'][0] }}"
  remote_user: "{{ remote_user }}"
  become: no
  vars:
    hadoop_home: "{{ bigdata_home }}/hadoop"
    hive_home: "{{ bigdata_home }}/hive"
  tasks:
    - name: Copy CSV file
      template:
        src: hive/external_test.csv
        dest: "{{ hive_home }}/external_test.csv"
    - name: Create HDFS directory
      command: "{{ hadoop_home }}/bin/hdfs dfs -mkdir -p /user/{{ remote_user }}/hive/external_test"
      failed_when: false
    - name: Upload CSV file
      command: "{{ hadoop_home }}/bin/hdfs dfs -put {{ hive_home }}/external_test.csv /user/{{ remote_user }}/hive/external_test/"
      failed_when: false
    - name: Delete temporary CSV
      file:
        path: "{{ hive_home }}/external_test.csv"
        state: absent
    - name: Check Database
      command: "{{ hive_home }}/bin/beeline -u jdbc:hive2://{{ groups['hive-server2'][0] }}:{{ hive.metastore.hive_server2_port }} -n {{ remote_user }} -e 'show databases;'"
      register: database_list
    - name: Create Database
      command: "{{ hive_home }}/bin/beeline -u jdbc:hive2://{{ groups['hive-server2'][0] }}:{{ hive.metastore.hive_server2_port }} -n {{ remote_user }} -e 'create database {{ remote_user }};'"
      when: remote_user not in database_list.stdout
    - name: Check Table
      command: "{{ hive_home }}/bin/beeline -u jdbc:hive2://{{ groups['hive-server2'][0] }}:{{ hive.metastore.hive_server2_port }} -n {{ remote_user }} -e 'show tables from {{ remote_user }};'"
      register: table_list
    - name: Create Table
      command: "{{ hive_home }}/bin/beeline -u jdbc:hive2://{{ groups['hive-server2'][0] }}:{{ hive.metastore.hive_server2_port }} -n {{ remote_user }} -e \"create external table igkim.external_test (id int, name string) row format delimited fields terminated by ',' location 'hdfs://igkim-hdfs/user/igkim/hive/external_test';\""
      when: "external_test" not in table_list.stdout
    - name: Select Table
      command: "{{ hive_home }}/bin/beeline -u jdbc:hive2://{{ groups['hive-server2'][0] }}:{{ hive.metastore.hive_server2_port }} -n {{ remote_user }} -e 'select id, name from {{ remote_user }}.external_test order by 1;'"
      register: query_result
    - name: Hive query result
      debug:
        var: query_result