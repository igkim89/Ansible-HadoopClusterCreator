---

- name: Stop Airflow Service
  hosts: airflow-webserver
  remote_user: "{{ remote_user }}"
  become: no
  vars:
    airflow_home: "/home/{{ remote_user }}/airflow"
  tasks:
    - name: Stop Airflow webserver
      command: ""
      failed_when: False

- name: Remove Setting a MySQL Database
  hosts: mysql
  remote_user: "{{ remote_user }}"
  become: no
  tasks:
    - name: Drop DB, User
      shell: |
        bin/mysql -uroot -p{{ mysql.root_pw }} --socket={{ mysql.socket_dir }}/mysql.sock -e "DROP DATABASE {{ airflow.db_name }};"
        bin/mysql -uroot -p{{ mysql.root_pw }} --socket={{ mysql.socket_dir }}/mysql.sock -e "DROP USER '{{ airflow.db_user }}';"
      args:
        chdir: "{{ mysql.home_dir }}"

- name: Uninstall Airflow
  hosts: airflow-webserver
  remote_user: "{{ remote_user }}"
  become: no
  vars:
    airflow_home: "/home/{{ remote_user }}/airflow"
  tasks:
    - name: Uninstall Airflow
      command: "pip uninstall apache-airflow[celery] -y"

- name: Remove Airflow directory
  hosts: airflow-webserver
  become: no
  vars:
    airflow_home: "/home/{{ remote_user }}/airflow"
  tasks:
    - name: Remove directory
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "/home/{{ remote_user }}/airflow"
        - "/home/{{ remote_user }}/airflow-tmp"
      failed_when: False